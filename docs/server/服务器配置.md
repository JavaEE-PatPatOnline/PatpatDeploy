# 服务器配置

> 本文介绍如何配置承载 Patpat Online 的服务器。

---

## 服务器配置

> 本章节介绍如何从初始化的服务器开始，配置之后所需要的基础服务器环境。

服务器的配置尽可能高一些，如 2 核 8 GB，推荐 4 核 16 GB。投入使用时，也推荐有较大的硬盘（128 GB）存储学生的提交（以及镜像）。

Patpat Online 部署相关操作均**不使用** root 用户，因此需要添加新用户。同时，为了实现 CI/CD，该用户在执行 sudo 命令时不能输入密码。

> 参考 [Create Sudo-Enabled User on Linux](https://www.tonys-studio.top/posts/Create-sudo-enabled-User-on-Linux/)。

配置好用户后，接下来所有操作都使用该用户完成。

> 为什么不用 root 用户？因为不想直接操作 root。

这里推荐使用 Visual Studio Code 远程连接服务器，并使用 Docker 插件，简化相关操作。

---

## 依赖安装与配置

> 本章节介绍宿主机上依赖的安装与配置，包括数据库、消息队列、Docker 和 K3s。
>
> *TODO：如果之后能将这些所有依赖都容器化，或许是更好的。*

### Nginx

> 参考 [Basic Serving and Proxying in Nginx](https://www.tonys-studio.top/posts/Basic-Serving-and-Proxying-in-Nginx/)。

### MySQL

> 参考 [Deploy MySQL on Linux Server](https://www.tonys-studio.top/posts/Deploy-MySQL-on-Linux-Server/)，需要添加 admin 用户允许远程连接，之后应用部署使用该用户连接 MySQL。

对于数据库的使用，正式投入生产使用 `patpat-prod`，生产环境测试使用 `patpat-stag`，本地测试使用 `patpat-dev`。初始化数据库使用 [PatBoot](https://github.com/JavaEE-PatPatOnline/PatBoot) 项目中的 `init.sql`，位于的 resources 目录下。生产环境注意更改 SQL 中 root 用户的默认密码，或是项目启动后，登录 root 账号更改密码。

### RabbitMQ

参考 [Setting Up RabbitMQ](https://www.tonys-studio.top/posts/Setting-up-RabbitMQ/)，使用 **Docker** 部署 RabbitMQ，需要添加 rabbit 用户允许远程连接，之后应用部署使用该用户连接 RabbitMQ。配置好后，可以通过 15672 端口访问 RabbitMQ 控制面板。

这里不用让 K3s 接管 RabbitMQ，让它作为单独的服务即可。

> 为什么使用 Docker 部署 RabbitMQ？因为直接安装非常麻烦，还容易出错。

### Docker & K3s

> 参考 [Deployment Practice With Kubernetes](https://www.tonys-studio.top/posts/Deployment-Practice-with-Kubernetes/) 中 Docker 和 K3s 安装和配置的相关说明，并根据其中 [Troubleshoot](https://www.tonys-studio.top/posts/Deployment-Practice-with-Kubernetes/#Troubleshoot) 部分禁用所有插件。 

`pause` 镜像为 K3s 所必须的，可以通过阿里云镜像 pull 到本地。

```bash
sudo docker pull registry.cn-hangzhou.aliyuncs.com/rancher/mirrored-pause:3.6
sudo docker tag registry.cn-hangzhou.aliyuncs.com/rancher/mirrored-pause:3.6 rancher/mirrored-pause:3.6
```

